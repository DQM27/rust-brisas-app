%% Flujo de Ingreso de Contratista
%% Pegar en https://mermaid.live para visualizar

sequenceDiagram
    autonumber
    
    participant G as ðŸ‘® Guardia
    participant FE as ðŸ–¥ï¸ Frontend
    participant BE as âš™ï¸ Backend
    participant MV as ðŸ“ Motor ValidaciÃ³n
    participant DB as ðŸ’¾ SQLite

    rect rgb(240, 248, 255)
        Note over G,DB: FASE 1: BÃºsqueda
        G->>FE: Busca contratista (nombre/cÃ©dula)
        FE->>BE: search_all(query)
        BE->>DB: Tantivy full-text search
        DB-->>BE: Resultados indexados
        BE-->>FE: Lista de coincidencias
        FE-->>G: Muestra opciones
    end
    
    rect rgb(255, 248, 240)
        Note over G,DB: FASE 2: ValidaciÃ³n
        G->>FE: Selecciona contratista
        FE->>BE: validate_ingreso_contratista(id)
        BE->>DB: Obtiene datos completos
        DB-->>BE: Contratista + historial
        BE->>MV: validar_ingreso(contexto)
        
        Note over MV: Verifica:<br/>âœ“ Lista negra<br/>âœ“ PRAIND vigente<br/>âœ“ Estado activo<br/>âœ“ Sin ingreso abierto
        
        MV-->>BE: ResultadoValidacion
        BE-->>FE: {puede_ingresar, alertas, bloqueo}
    end
    
    rect rgb(240, 255, 240)
        Note over G,DB: FASE 3: Registro
        alt âœ… Puede Ingresar
            G->>FE: Selecciona modo y gafete
            FE->>BE: create_ingreso_contratista(datos)
            BE->>DB: INSERT ingreso
            BE->>DB: UPDATE gafete (estado: en_uso)
            BE-->>FE: Ingreso creado âœ…
            FE-->>G: Confirma entrada
        else âŒ Bloqueado
            BE-->>FE: Motivo de bloqueo
            FE-->>G: Muestra error y razÃ³n
        end
    end
