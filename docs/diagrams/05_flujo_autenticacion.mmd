%% Flujo de AutenticaciÃ³n
%% Pegar en https://mermaid.live para visualizar

sequenceDiagram
    autonumber
    
    participant U as ðŸ‘¤ Usuario
    participant FE as ðŸ–¥ï¸ Frontend
    participant BE as âš™ï¸ Backend
    participant KR as ðŸ” Keyring
    participant SS as ðŸ“‹ Session State
    participant DB as ðŸ’¾ SQLite

    rect rgb(255, 240, 245)
        Note over U,DB: LOGIN
        U->>FE: Ingresa email y contraseÃ±a
        FE->>BE: login(email, password)
        BE->>DB: SELECT user WHERE email
        DB-->>BE: User + password_hash
        
        BE->>KR: get_argon2_params()
        KR-->>BE: {salt, memory, iterations}
        
        BE->>BE: Argon2 verify(password, hash)
        
        alt âœ… Credenciales VÃ¡lidas
            BE->>SS: set_current_user(user)
            BE->>DB: SELECT role + permissions
            DB-->>BE: Permisos del rol
            BE-->>FE: {user, role, permissions}
            FE->>FE: Guarda en authStore
            FE-->>U: Redirige a Dashboard
        else âŒ Credenciales InvÃ¡lidas
            BE-->>FE: UserError::InvalidCredentials
            FE-->>U: Muestra error
        end
    end
    
    rect rgb(240, 248, 255)
        Note over U,DB: VERIFICACIÃ“N DE PERMISOS
        U->>FE: Intenta acceder a mÃ³dulo
        FE->>FE: authStore.hasPermission(module, action)
        
        alt âœ… Tiene Permiso
            FE-->>U: Muestra contenido
        else âŒ Sin Permiso
            FE-->>U: Acceso denegado
        end
    end
    
    rect rgb(255, 255, 240)
        Note over U,DB: LOGOUT
        U->>FE: Click en salir
        FE->>BE: logout()
        BE->>SS: clear_session()
        BE-->>FE: OK
        FE->>FE: Limpia authStore
        FE-->>U: Redirige a Login
    end
